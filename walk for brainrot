-- Global variables to ensure they are accessible everywhere
local gnum = 16 
_G.Collecting = false

function safeloadstring(url)
    local success, code = pcall(game.HttpGet, game, url)
    if not success then warn("Failed to fetch URL") return nil end
    
    local func, errorMessage = loadstring(code)
    if func then
        print("Script compiled! Executing...")
        return func()
    else
        warn("LOADSTRING FAILED: " .. tostring(errorMessage))
        return nil
    end
end

local UILibrary = safeloadstring("https://raw.githubusercontent.com/SugaBlaz/UI-Library/refs/heads/main/MainUI")
local doneloading = false
local LP = game:GetService("Players").LocalPlayer
local RS = game:GetService("RunService")

local Char = LP.Character or LP.CharacterAdded:Wait()
LP.CharacterAdded:Connect(function(newChar) Char = newChar end)

local SelectedBrainrots = {}

local ui = UILibrary.Main.new({
    TitleText = "Walk For Brainrot",
    Size = UDim2.new(0, 175, 0, 225),
	Position = UDim2.new(0.5, -140, 0.5, -190),
	TitleHeight = 30,
	CornerRadius = 6,
	ElementPadding = 6,
	Font = Enum.Font.GothamBold,
	TextSize = 12,
	SectionHeight = 20,
	UIStrokeThickness = 1,
	SliderColor = Color3.fromRGB(54, 54, 54),
	NotifcationSound = "rbxassetid://80833448337193",
	ResetOnSpawn = false,
	Addons = {},
	KeySystemEnabled = false,
	TabPadding = 10,
	UseOwnTheme = false,
    Theme = "Serenity",
    SaveOnExit = true,
})

ui:CreateFakeLoading({
		Size = UDim2.new(0, 189, 0, 126),
		Position = UDim2.new(0.471, 0, 0.492, 0),
		Title = "Loading Universal Hub...",
		Description = "Subscribe to KeelSugaBlaz!",
		WaitTime = {0.01, 0.1}, -- the time between moving the bar
		WaitTime2 = {0.01, 0.1}, -- the time to wait before activbating the waittime2
		UIStrokeEnabled = true,
		UIStrokeThickness = 2,
		CallBack = function()
			doneloading = true
		end,
	})

repeat task.wait() until doneloading

ui:AddSection("Main")

ui:AddMultiDropdown({
    Text = "Brainrot Rarity",
    Options = {"Common", "Uncommon", "Rare", "Epic", "Legendary", "Mythic", "Brainrot God", "Secret"},
	Default = {},
    Callback = function(selectedList)
        SelectedBrainrots = selectedList
    end,
})

function Collect(v)
    if v and v.PrimaryPart and Char:FindFirstChild("HumanoidRootPart") then
        local root = Char.HumanoidRootPart
        -- Improved search for the prompt
        local prompt = v:FindFirstChildOfClass("ProximityPrompt") or v.PrimaryPart:FindFirstChildOfClass("ProximityPrompt") or v:FindFirstChildWhichIsA("ProximityPrompt", true)

        if prompt then
            local oldCFrame = root.CFrame
            root.CFrame = v.PrimaryPart.CFrame
            task.wait(0.15) -- Delta needs a tiny bit more time to register position

            fireproximityprompt(prompt)
            
            task.wait(0.1)
            -- Return to plot (ensure this path exists in your game!)
            if workspace.World.Positions.Plot:FindFirstChild("2") then
                root.CFrame = workspace.World.Positions.Plot["2"].CFrame
            end
        end
    end
end

-- FIXED TOGGLE & LOOP
ui:AddToggle({
    Text = "Start Collecting Brainrots",
    Default = false,
    Callback = function(state)
        _G.Collecting = state 

        if state then
            task.spawn(function()
                while _G.Collecting do
                    local notcollected = {}

                    -- Scans spawned entities
                    for _, v in pairs(workspace.SpawnedEntities:GetChildren()) do
                        local billboard = v:FindFirstChild("SpawnedEntityBillboard")
                        local rarityLabel = billboard and billboard.Frame:FindFirstChild("Rarity")
                        
                        if rarityLabel and v.PrimaryPart then
                            local rartext = rarityLabel.Text
                            -- Check if rarity is in our selected list
                            if table.find(SelectedBrainrots, rartext) then
                                table.insert(notcollected, v)
                            end
                        end
                    end

                    -- Process the list
                    for i = #notcollected, 1, -1 do
                        if not _G.Collecting then break end
                        local target = notcollected[i]
                        if target and target.Parent then
                            Collect(target)
                            task.wait(0.3) -- Delay between collects to prevent anti-cheat kicks
                        end
                    end
                    task.wait(0.5) -- Wait before scanning again
                end
            end)
        end
    end,
})

ui:AddSlider({
    Text = "Walkspeed",
    Default = 16,
    Min = 0,
    Max = 1000,
    Callback = function(num)
        gnum = num
    end,
})

RS.RenderStepped:Connect(function()
    if Char and Char:FindFirstChild("Humanoid") then
        Char.Humanoid.WalkSpeed = gnum
    end
end)

RS.PreRender:Connect(function()
    if Char and Char:FindFirstChild("Humanoid") then
        Char.Humanoid.WalkSpeed = gnum
    end
end)
